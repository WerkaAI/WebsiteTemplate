# Security Headers Specification

_Version 1.0 — Drafted 2025-10-27_

## Objectives
- Enforce defense-in-depth across the marketing site without blocking redirects to `app.autozaba.pl`.
- Ship a nonce-based Content Security Policy (CSP) that eliminates `unsafe-inline` / `unsafe-eval` while preserving structured data scripts.
- Maintain compatibility with existing embeds (YouTube, Turnstile, Unsplash/DigitalOcean images) and outbound social share links.
- Roll out via `Content-Security-Policy-Report-Only` before switching to enforcement.

Aktualizacja 2026-02-21:
- lifecycle gate per project wdrożony (`build -> pre-release -> release`),
- telemetry endpoint aktywny domyślnie: `/api/csp-report`.

## Header Set & Owners
| Header | Status | Owner | Notes |
| --- | --- | --- | --- |
| `Content-Security-Policy` | New (nonce strategy) | Web Platform | Generated per-request with nonce + allow-lists below |
| `Content-Security-Policy-Report-Only` | Rollout phase | Web Platform | Mirrors enforcing policy with report URI |
| `Report-To`, `NEL` | Optional | Infra | Integrate with chosen CSP report collector |
| `Strict-Transport-Security` | Existing | Platform | Keep `max-age=63072000; includeSubDomains; preload` (prod only) |
| `X-Frame-Options` | Existing | Platform | `SAMEORIGIN` |
| `Permissions-Policy` | Update | Platform | Expand to include `fullscreen=(), payment=()` etc. |
| `Referrer-Policy` | Existing | Marketing | Consider bump to `strict-origin-when-cross-origin` |
| `X-Content-Type-Options` | Existing | Platform | `nosniff` |

## CSP Blueprint
The CSP will be generated by `src/lib/security/headers.ts` using the structure below. Each directive is a controlled array to simplify allow-list editing.

```ts
export type CspDirectives = {
  readonly "default-src": readonly string[];
  readonly "base-uri": readonly string[];
  readonly "frame-ancestors": readonly string[];
  readonly "form-action": readonly string[];
  readonly "frame-src": readonly string[];
  readonly "style-src": readonly string[];
  readonly "img-src": readonly string[];
  readonly "font-src": readonly string[];
  readonly "script-src": readonly string[]; // auto-injected nonce added at runtime
  readonly "connect-src": readonly string[];
  readonly "media-src": readonly string[];
  readonly "object-src": readonly string[];
  readonly "upgrade-insecure-requests"?: readonly string[]; // presence toggled via flag
  readonly "report-uri"?: readonly string[];
};
```

### Directive Values
| Directive | Allow-List | Justification |
| --- | --- | --- |
| `default-src` | `'self'` | Catch-all fallback |
| `base-uri` | `'self'` | Prevent base tag override |
| `frame-ancestors` | `'self'` | Maintain clickjacking coverage |
| `form-action` | `'self'` `https://app.autozaba.pl` | Allow CTA forms that post to app tier if introduced |
| `frame-src` | `'self'`, `https://www.youtube.com`, `https://www.youtube-nocookie.com` | Existing embeds per inventory |
| `style-src` | `'self'`, `'unsafe-inline'` (temporary), `https://fonts.googleapis.com` | `unsafe-inline` removed once CSS inline styles eliminated |
| `img-src` | `'self'`, `data:`, `https://images.unsplash.com`, `https://autozaba-app-storage.fra1.cdn.digitaloceanspaces.com` | Published remote assets |
| `font-src` | `'self'`, `data:`, `https://fonts.gstatic.com` | Web fonts |
| `script-src` | `'self'`, `https://challenges.cloudflare.com`, `'nonce-{runtime}'` | Cloudflare Turnstile + runtime nonce |
| `connect-src` | `'self'`, `https://challenges.cloudflare.com` | Turnstile verification |
| `media-src` | `'self'`, `https://www.youtube.com`, `https://www.youtube-nocookie.com` | Embedded videos |
| `object-src` | `'none'` | Mitigate plugin attacks |
| `report-uri` | `https://security-autozaba.report-uri.com/csp` (placeholder) | Replace with actual collector |

**Nonce Handling:**
- Generate nonce per request in middleware (`src/lib/security/csp.ts`).
- Inject `script-src 'nonce-<value>'` and attach `nonce` attribute to all server-rendered inline scripts (JSON-LD, Turnstile fallback).
- Maintain helper to append `unsafe-inline` only when `process.env.CSP_ALLOW_UNSAFE_INLINE === '1'` for debugging.

**Hashing Strategy (future):**
- For static inline scripts that cannot receive runtime nonce, compute SHA256 hashes during build and append to `script-src`.

### Report-Only Mode
- During rollout, serve `Content-Security-Policy-Report-Only` with identical directives plus `report-uri`.
- Enforce a 72-hour observation window capturing violations to `docs/security/csp-violations-YYYY-MM-DD.md` for manual summary.

## Permissions Policy Refresh
Target policy string: `accelerometer=(), ambient-light-sensor=(), autoplay=(), camera=(), display-capture=(), fullscreen=(self), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()`.

## Implementation Checklist
1. Add `src/lib/security/csp.ts` with nonce generator + helper to apply directives.
2. Refactor `next.config.ts` headers export to consume shared helper and inject per-route CSP.
3. Update `_app` or layout templates to attach nonce to `<Head>` inline scripts (JSON-LD, Turnstile fallback script if present).
4. Configure report endpoint URL (self-hosted API route or third-party). If self-hosted, create `/api/csp-report` to log payloads securely.
5. Add Vitest snapshot verifying the generated header strings from `headers.ts`.
6. Document allow-list changes in `docs/security/post-rollout.md`.

## Runtime Configuration Flags
- `CSP_MODE`: explicit override (`report-only`, `enforce`, `dual`) — highest priority.
- `CSP_LIFECYCLE_STAGE`: `build` (default), `pre-release`, `release`.
  - `build` -> `report-only`
  - `pre-release` -> `dual`
  - `release` -> `enforce`
- `CSP_ALLOW_UNSAFE_INLINE`: set to `1` for troubleshooting to append `'unsafe-inline'` back into `script-src`.
- `CSP_ALLOW_UNSAFE_EVAL`: set to `1` to temporarily re-enable `'unsafe-eval'`.
- `CSP_DISABLE_UPGRADE_INSECURE_REQUESTS`: set to `1` to drop the directive altogether.
- `CSP_REPORT_URI`: absolute URL for violation collection; omit to disable reporting.
- `CSP_DISABLE`: set to `1` to bypass middleware entirely (debug builds only).

## Operational Checklist
- Release checklist: [docs/security/csp-release-checklist.md](csp-release-checklist.md)
- Telemetry log: [docs/security/post-rollout.md](post-rollout.md)

## Non-Goals
- HSTS preload submission management (handled by infrastructure).
- Application-level rate limiting (tracked separately for `/api/contact`).
